{% extends 'base.html' %}
{% block title %}Team Bookings{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-calendar-check"></i> Team Bookings</h4>
    <div>
      <span class="badge bg-secondary me-2">Total: {{ stats.total|default:0 }}</span>
      <span class="badge bg-warning text-dark me-2">Pending: {{ stats.pending|default:0 }}</span>
      <span class="badge bg-success me-2">Paid: {{ stats.paid|default:0 }}</span>
      <span class="badge bg-info text-dark me-2">Completed: {{ stats.completed|default:0 }}</span>
      <span class="badge bg-danger me-2">Cancelled: {{ stats.cancelled|default:0 }}</span>
    </div>
  </div>

  {% if bookings %}
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Booking</th>
          <th>Client</th>
          <th>Service</th>
          <th class="text-end">Amount</th>
          <th>Payment</th>
          <th>Status</th>
          <th>Sales Employee</th>
          <th>Manager</th>
          <th>Created</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for b in bookings %}
        <tr>
          <td>{{ b.booking_id }}</td>
          <td>{{ b.client.company_name }}</td>
          <td>{{ b.service.name }}</td>
          <td class="text-end">â‚¹{{ b.final_amount|default:b.amount }}</td>
          <td>
            {% if b.payment %}
              <span class="badge bg-{% if b.payment.status == 'CAPTURED' %}success{% elif b.payment.status == 'PENDING' %}warning{% elif b.payment.status == 'FAILED' %}danger{% else %}secondary{% endif %}">
                {{ b.payment.get_status_display }}
              </span>
            {% else %}
              <span class="badge bg-secondary">UNPAID</span>
            {% endif %}
          </td>
          <td>{{ b.get_status_display }}</td>
          <td>
            {% if b.assigned_to %}
              {{ b.assigned_to.get_full_name|default:b.assigned_to.username }}
            {% elif b.client.assigned_sales %}
              {{ b.client.assigned_sales.get_full_name|default:b.client.assigned_sales.username }}
              <small class="text-muted">(via client)</small>
            {% else %}
              <span class="text-muted">Unassigned</span>
            {% endif %}
          </td>
          <td>
            {% if b.assigned_to.manager %}
              {{ b.assigned_to.manager.get_full_name|default:b.assigned_to.manager.username }}
            {% elif b.client.assigned_sales.manager %}
              {{ b.client.assigned_sales.manager.get_full_name|default:b.client.assigned_sales.manager.username }}
              <small class="text-muted">(via client)</small>
            {% elif b.client.assigned_manager %}
              {{ b.client.assigned_manager.get_full_name|default:b.client.assigned_manager.username }}
              <small class="text-muted">(client mgr)</small>
            {% else %}
              <span class="text-muted">No manager</span>
            {% endif %}
          </td>
          <td>{{ b.booking_date|date:'M d, Y' }}</td>
          <td class="text-end">
            {% if b.payment and b.payment.status == 'PENDING' %}
              <a href="{% url 'accounts:approve_payment' b.payment.id %}?next={{ request.path|urlencode }}" class="btn btn-sm btn-success me-1">
                <i class="bi bi-check-circle"></i> Approve
              </a>
              <a href="{% url 'accounts:reject_payment' b.payment.id %}?next={{ request.path|urlencode }}" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-x-circle"></i> Reject
              </a>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="alert alert-light text-center">No team bookings found.</div>
  {% endif %}
</div>
{% endblock %}
