{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-calendar-plus"></i> {{ page_title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'clients:client_detail' client.id %}">{{ client.company_name }}</a></li>
                    <li class="breadcrumb-item active">Create Booking</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-check"></i> New Booking for {{ client.company_name }}</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="service_id" class="form-label fw-bold">
                                    Service <span class="text-danger">*</span>
                                </label>
                                <select name="service_id" id="service_id" class="form-select" required>
                                    <option value="">-- Select Service --</option>
                                    {% regroup services by category as service_groups %}
                                    {% for group in service_groups %}
                                        <optgroup label="{{ group.grouper }}">
                                            {% for service in group.list %}
                                                <option value="{{ service.id }}" data-price="{{ service.price }}">
                                                    {{ service.name }} - ₹{{ service.price }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Service to be provided</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="scheme_id" class="form-label fw-bold">
                                    Scheme (if applicable)
                                </label>
                                <select name="scheme_id" id="scheme_id" class="form-select">
                                    <option value="">-- No Scheme / Direct Service --</option>
                                    {% regroup schemes by category as scheme_groups %}
                                    {% for group in scheme_groups %}
                                        <optgroup label="{{ group.grouper }}">
                                            {% for scheme in group.list %}
                                                <option value="{{ scheme.id }}">
                                                    {{ scheme.name }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select if applying for a government scheme</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="amount" class="form-label fw-bold">
                                    Service Amount (₹) <span class="text-danger">*</span>
                                </label>
                                <input type="number" name="amount" id="amount" class="form-control" 
                                       step="0.01" min="0" placeholder="5000.00" required>
                                <div class="form-text">Our service charges</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="upfront_amount" class="form-label fw-bold">
                                    Upfront Payment (₹)
                                </label>
                                <input type="number" name="upfront_amount" id="upfront_amount" class="form-control" 
                                       step="0.01" min="0" placeholder="2000.00" value="0">
                                <div class="form-text">Advance payment received</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="discount" class="form-label fw-bold">
                                    Discount (%)
                                </label>
                                <input type="number" name="discount" id="discount" class="form-control" 
                                       step="0.01" min="0" max="100" placeholder="10" value="0">
                                <div class="form-text">Discount percentage</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="funding_amount" class="form-label fw-bold">
                                    Loan/Grant Amount (₹)
                                </label>
                                <input type="number" name="funding_amount" id="funding_amount" class="form-control" 
                                       step="0.01" min="0" placeholder="1000000.00">
                                <div class="form-text">Amount client is seeking from scheme (if applicable)</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="priority" class="form-label fw-bold">Priority</label>
                                <select name="priority" id="priority" class="form-select">
                                    <option value="LOW">Low</option>
                                    <option value="MEDIUM" selected>Medium</option>
                                    <option value="HIGH">High</option>
                                    <option value="URGENT">Urgent</option>
                                </select>
                                <div class="form-text">Processing priority</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="requirements" class="form-label fw-bold">Requirements / Notes</label>
                            <textarea name="requirements" id="requirements" class="form-control" rows="3" 
                                      placeholder="Add any specific requirements, deadlines, or notes for this booking"></textarea>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> <strong>Booking Summary:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Client:</strong> {{ client.company_name }}</li>
                                <li><strong>Contact:</strong> {{ client.contact_person }} ({{ client.contact_email }})</li>
                                {% if client.assigned_sales %}
                                <li><strong>Assigned To:</strong> {{ client.assigned_sales.get_full_name }}</li>
                                {% else %}
                                <li><strong>Assigned To:</strong> You ({{ request.user.get_full_name }})</li>
                                {% endif %}
                                <li><strong>Status:</strong> Pending Payment</li>
                            </ul>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Create Booking
                            </button>
                            <a href="{% url 'clients:client_detail' client.id %}" class="btn btn-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Booking Information</h6>
                </div>
                <div class="card-body">
                    <p><strong>Service Charges:</strong></p>
                    <p class="small">Enter the amount you're charging the client for the service. This will be shown on the invoice.</p>
                    
                    <p class="mt-3"><strong>Upfront Payment:</strong></p>
                    <p class="small">If you've received any advance payment from the client, enter it here. This helps track partial payments.</p>
                    
                    <p class="mt-3"><strong>Scheme Details:</strong></p>
                    <p class="small">If the client is applying for a government scheme (loan/grant), select the scheme and enter the funding amount they're seeking.</p>
                    
                    <p class="mt-3"><strong>Discount:</strong></p>
                    <p class="small">Apply percentage discount if any special offer or negotiation was made.</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-calculator"></i> Amount Calculation</h6>
                </div>
                <div class="card-body">
                    <div id="amount-summary" class="small">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Service Amount:</span>
                            <strong id="display-amount">₹0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Discount:</span>
                            <span id="display-discount">₹0.00 (0%)</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Final Amount:</strong>
                            <strong class="text-success" id="display-final">₹0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Upfront Paid:</span>
                            <span id="display-upfront">₹0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Balance Due:</strong>
                            <strong class="text-danger" id="display-balance">₹0.00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Live calculation of amounts
function calculateAmounts() {
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const upfront = parseFloat(document.getElementById('upfront_amount').value) || 0;
    
    const discountAmount = (amount * discount) / 100;
    const finalAmount = amount - discountAmount;
    const balance = finalAmount - upfront;
    
    document.getElementById('display-amount').textContent = '₹' + amount.toFixed(2);
    document.getElementById('display-discount').textContent = '₹' + discountAmount.toFixed(2) + ' (' + discount + '%)';
    document.getElementById('display-final').textContent = '₹' + finalAmount.toFixed(2);
    document.getElementById('display-upfront').textContent = '₹' + upfront.toFixed(2);
    document.getElementById('display-balance').textContent = '₹' + balance.toFixed(2);
}

// Auto-fill amount from service selection
document.getElementById('service_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const price = selectedOption.getAttribute('data-price');
    if (price) {
        document.getElementById('amount').value = price;
        calculateAmounts();
    }
});

// Recalculate on input change
document.getElementById('amount').addEventListener('input', calculateAmounts);
document.getElementById('discount').addEventListener('input', calculateAmounts);
document.getElementById('upfront_amount').addEventListener('input', calculateAmounts);

// Initial calculation
calculateAmounts();
</script>
{% endblock %}