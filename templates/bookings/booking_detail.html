{% extends 'base.html' %}

{% block title %}Booking {{ booking.booking_id }} - Agnivridhi CRM{% endblock %}

{% block sidebar %}
<nav class="col-md-3 col-lg-2 d-md-block sidebar">
  <div class="position-sticky pt-3">
    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link" href="{{ dashboard_url }}"><i class="bi bi-house"></i> Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'bookings:booking_list' %}"><i class="bi bi-list"></i> Bookings</a></li>
    </ul>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="mb-3">
  <a href="{% url 'bookings:booking_list' %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Bookings</a>
</div>

<h1 class="h2 mb-4">Booking {{ booking.booking_id }}</h1>

<div class="card mb-4">
  <div class="card-header">Summary</div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <p><strong>Client:</strong> {{ booking.client.company_name }}</p>
        <p><strong>Service:</strong> {{ booking.service.name }}</p>
        <p><strong>Amount:</strong> ₹{{ booking.final_amount|default:booking.amount }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Status:</strong> <span class="badge bg-secondary">{{ booking.get_status_display }}</span></p>
        <p><strong>Assigned To:</strong> {{ booking.assigned_to.get_full_name|default:booking.assigned_to.username }}</p>
        <p><strong>Date:</strong> {{ booking.booking_date|date:"M d, Y" }}</p>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">Payment</div>
  <div class="card-body">
    {% if booking.payment %}
      <p><strong>Status:</strong> <span class="badge bg-{% if booking.payment.status == 'CAPTURED' %}success{% elif booking.payment.status == 'PENDING' %}warning{% elif booking.payment.status == 'FAILED' %}danger{% else %}secondary{% endif %}">{{ booking.payment.get_status_display }}</span></p>
      <p><strong>Amount:</strong> ₹{{ booking.payment.amount }}</p>
      <p><strong>Method:</strong> {{ booking.payment.get_payment_method_display }}</p>
      <p><strong>Reference:</strong> <code>{{ booking.payment.reference_id|default:'-' }}</code></p>
      {% if booking.payment.status == 'PENDING' %}
        {% if request.user.is_manager or request.user.is_admin %}
          <a href="{% url 'accounts:approve_payment' booking.payment.id %}?next={{ request.path|urlencode }}" class="btn btn-success btn-sm me-2"><i class="bi bi-check-circle"></i> Approve</a>
          <a href="{% url 'accounts:reject_payment' booking.payment.id %}?next={{ request.path|urlencode }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-x-circle"></i> Reject</a>
        {% endif %}
      {% endif %}
    {% else %}
      <p class="text-muted">No payment recorded yet.</p>
      {% if request.user.role == 'SALES' and booking.assigned_to_id == request.user.id %}
        <a href="{% url 'accounts:record_payment' booking.id %}" class="btn btn-success btn-sm"><i class="bi bi-cash-coin"></i> Record Payment</a>
      {% endif %}
    {% endif %}
  </div>
</div>

{% if booking.payment and booking.payment.status == 'CAPTURED' %}
<div class="card">
  <div class="card-header">Next Steps</div>
  <div class="card-body">
    {% if request.user.role == 'SALES' and booking.assigned_to_id == request.user.id %}
      <a href="{% url 'applications:create_application_from_booking' booking.id %}" class="btn btn-primary btn-sm"><i class="bi bi-file-earmark-plus"></i> Create Application</a>
    {% else %}
      <p class="text-muted">Application creation is available to assigned sales after payment approval.</p>
    {% endif %}
  </div>
</div>
{% endif %}

{% endblock %}
