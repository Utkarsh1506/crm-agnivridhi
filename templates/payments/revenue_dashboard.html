{% extends 'base.html' %}

{% block title %}Revenue Dashboard - Agnivridhi CRM{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2"><i class="bi bi-graph-up-arrow"></i> Revenue</h1>
    <a href="{{ dashboard_url|default:'/dashboard/' }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Totals -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card stats-card">
        <div class="card-body">
          <h6 class="text-muted">Total Pitched</h6>
          <h2>₹{{ totals.total_pitched|default:0|floatformat:2 }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stats-card bg-success text-white">
        <div class="card-body">
          <h6>Received</h6>
          <h2>₹{{ totals.total_received|default:0|floatformat:2 }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stats-card bg-warning text-white">
        <div class="card-body">
          <h6>Pending</h6>
          <h2>₹{{ totals.total_pending|default:0|floatformat:2 }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Clients Summary -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div><i class="bi bi-people"></i> Clients Summary</div>
      <span class="badge bg-secondary">{{ clients|length }} clients</span>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Client</th>
              <th>Sales</th>
              <th>Manager</th>
              <th>Pitched</th>
              <th>Received</th>
              <th>Pending</th>
            </tr>
          </thead>
          <tbody>
            {% for client in clients %}
            <tr>
              <td><strong>{{ client.company_name }}</strong></td>
              <td>{{ client.assigned_sales.get_full_name|default:client.assigned_sales.username|default:"-" }}</td>
              <td>
                {% if client.assigned_sales and client.assigned_sales.manager %}
                  {{ client.assigned_sales.manager.get_full_name|default:client.assigned_sales.manager.username }}
                {% elif client.assigned_manager %}
                  {{ client.assigned_manager.get_full_name|default:client.assigned_manager.username }}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>₹{{ client.total_pitched_amount|floatformat:2 }}</td>
              <td>₹{{ client.received_amount|floatformat:2 }}</td>
              <td>₹{{ client.pending_amount|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recent Revenue Logs -->
  <div class="card">
    <div class="card-header"><i class="bi bi-clock-history"></i> Recent Revenue Logs</div>
    <div class="card-body">
      {% if entries %}
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Time</th>
              <th>Client</th>
              <th>Recorded By</th>
              <th>Source</th>
              <th>Pitched</th>
              <th>Received</th>
              <th>Pending</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            {% for e in entries %}
            <tr>
              <td>{{ e.created_at|date:"M d, Y H:i" }}</td>
              <td>{{ e.client.company_name }}</td>
              <td>{{ e.recorded_by.get_full_name|default:e.recorded_by.username|default:"-" }}</td>
              <td><span class="badge bg-secondary">{{ e.get_source_display }}</span></td>
              <td>₹{{ e.total_pitched_amount|floatformat:2 }}</td>
              <td>₹{{ e.received_amount|floatformat:2 }}</td>
              <td>₹{{ e.pending_amount|floatformat:2 }}</td>
              <td class="text-muted">{{ e.note|default:"-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No revenue entries recorded yet.
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
