{% extends 'base.html' %}

{% block title %}Create Invoice - Agnivridhi CRM{% endblock %}

{% block sidebar %}
{# same sidebar as above / sales dashboard #}
<nav class="col-md-3 col-lg-2 d-md-block sidebar">
    <div class="position-sticky pt-3">
        <ul class="nav flex-column">
            <!-- your existing items -->
            <li class="nav-item">
                <a class="nav-link" href="{% url 'accounts:sales_dashboard' %}">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <!-- ... -->
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'invoices:sales_invoice_list' %}">
                    <i class="bi bi-receipt"></i> Invoices & Proformas
                </a>
            </li>
        </ul>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">
        <i class="bi bi-plus-circle"></i> Create Invoice / Proforma
    </h1>
    <a href="{% url 'invoices:sales_invoice_list' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-info-circle"></i> Basic Information
    </div>
    <div class="card-body">
        <form method="post" id="invoiceForm">
            {% csrf_token %}

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Invoice Type <span class="text-danger">*</span></label>
                    {{ form.invoice_type }}
                    <small class="form-text text-muted">Proforma for quotation, Tax for final bill</small>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label fw-bold">Select Client <span class="text-danger">*</span></label>
                    {{ form.client }}
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label fw-bold">Issue Date <span class="text-danger">*</span></label>
                    {{ form.issue_date }}
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label fw-bold">Due Date</label>
                    {{ form.due_date }}
                    <small class="form-text text-muted">Optional</small>
                </div>
            </div>

            <hr class="my-4">

            <div class="card-header bg-success text-white mb-3">
                <i class="bi bi-box-seam"></i> Item & Pricing Details
            </div>
            
            <div class="row">
                <div class="col-md-7 mb-3">
                    <label class="form-label fw-bold">Item Description <span class="text-danger">*</span></label>
                    {{ form.item_description }}
                    <small class="form-text text-muted">E.g., "Consultancy Services for Scheme Application"</small>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">HSN/SAC Code</label>
                    {{ form.hsn_sac }}
                    <small class="form-text text-muted">Service code (optional)</small>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label fw-bold">GST Rate (%) <span class="text-danger">*</span></label>
                    {{ form.gst_rate }}
                    <small class="form-text text-muted">Usually 18%</small>
                </div>
            </div>

            <div class="row">
                <div class="col-md-2 mb-3">
                    <label class="form-label fw-bold">Quantity <span class="text-danger">*</span></label>
                    {{ form.quantity }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Rate per Unit (₹) <span class="text-danger">*</span></label>
                    {{ form.rate }}
                    <small class="form-text text-muted">Amount before tax</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Place of Supply <span class="text-danger">*</span></label>
                    {{ form.place_of_supply }}
                    <small class="form-text text-muted">State name (for CGST/SGST vs IGST)</small>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label fw-bold">State Code</label>
                    {{ form.place_of_supply_code }}
                    <small class="form-text text-muted">E.g., 27</small>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold">Additional Notes</label>
                {{ form.notes }}
                <small class="form-text text-muted">Any special instructions or terms</small>
            </div>

            <!-- Quick calculation preview -->
            <div class="alert alert-info">
                <h6 class="mb-2"><i class="bi bi-calculator"></i> Quick Preview</h6>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Taxable Amount:</strong> <span id="previewAmount">₹0.00</span>
                    </div>
                    <div class="col-md-3">
                        <strong>GST:</strong> <span id="previewGST">₹0.00</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Total:</strong> <span id="previewTotal" class="text-primary fs-5">₹0.00</span>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-file-earmark-pdf"></i> Generate Invoice PDF
                </button>
                <a href="{% url 'invoices:sales_invoice_list' %}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // Simple calculation preview
    document.addEventListener('DOMContentLoaded', function() {
        const qtyField = document.querySelector('[name="quantity"]');
        const rateField = document.querySelector('[name="rate"]');
        const gstField = document.querySelector('[name="gst_rate"]');
        
        function updatePreview() {
            const qty = parseFloat(qtyField?.value || 0);
            const rate = parseFloat(rateField?.value || 0);
            const gstRate = parseFloat(gstField?.value || 0);
            
            const amount = qty * rate;
            const gstAmount = amount * gstRate / 100;
            const total = amount + gstAmount;
            
            document.getElementById('previewAmount').textContent = '₹' + amount.toFixed(2);
            document.getElementById('previewGST').textContent = '₹' + gstAmount.toFixed(2);
            document.getElementById('previewTotal').textContent = '₹' + total.toFixed(2);
        }
        
        qtyField?.addEventListener('input', updatePreview);
        rateField?.addEventListener('input', updatePreview);
        gstField?.addEventListener('input', updatePreview);
        
        // Initial calculation
        updatePreview();
    });
</script>

<style>
    #invoiceForm .form-select,
    #invoiceForm .form-control {
        border-radius: 0.375rem;
    }
    #invoiceForm .form-label.fw-bold {
        color: #333;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}
