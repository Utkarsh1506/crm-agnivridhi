{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block sidebar %}
{% if user.role == 'SALES' %}
<nav class="col-md-3 col-lg-2 d-md-block sidebar">
    <div class="position-sticky pt-3">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'accounts:sales_dashboard' %}">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'clients:sales_clients_list' %}">
                    <i class="bi bi-people"></i> My Clients
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'bookings:sales_bookings_list' %}">
                    <i class="bi bi-calendar-check"></i> My Bookings
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'applications:sales_applications_list' %}">
                    <i class="bi bi-file-earmark-text"></i> Applications
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'payments:sales_payments_list' %}">
                    <i class="bi bi-credit-card"></i> Payments
                </a>
            </li>
        </ul>
    </div>
</nav>
{% elif user.role == 'MANAGER' %}
<nav class="col-md-3 col-lg-2 d-md-block sidebar">
    <div class="position-sticky pt-3">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'accounts:manager_dashboard' %}">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'clients:pending_approval_clients' %}">
                    <i class="bi bi-clock-history"></i> Pending Approvals
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'clients:manager_clients_list' %}">
                    <i class="bi bi-people"></i> Team Clients
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'applications:team_applications_list' %}">
                    <i class="bi bi-file-earmark-text"></i> Applications
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'accounts:team_members_list' %}">
                    <i class="bi bi-people-fill"></i> My Team
                </a>
            </li>
        </ul>
    </div>
</nav>
{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-person-plus"></i> {{ page_title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ dashboard_url }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Create Client</li>
                </ol>
            </nav>
        </div>
    </div>

    {% if user.role == 'SALES' %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> 
        <strong>Quick Client Creation:</strong> Just provide basic contact details. 
        <br><small>Your manager will need to approve this client before login credentials are generated.</small>
    </div>
    {% else %}
    <div class="alert alert-success">
        <i class="bi bi-info-circle"></i> 
        <strong>Quick Client Creation:</strong> Only 4 fields required. Client will fill remaining details after login.
        <br><small>Login credentials will be auto-generated and shown on Owner Dashboard.</small>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-plus"></i> Quick Client Creation</h5>
            <small>Client will complete their profile after receiving login credentials</small>
        </div>
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
                {% endif %}

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="{{ form.company_name.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-building"></i> Company Name <span class="text-danger">*</span>
                        </label>
                        {{ form.company_name }}
                        <div class="form-text">Registered company or business name</div>
                        {% if form.company_name.errors %}
                        <div class="text-danger mt-1">{{ form.company_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.contact_person.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-person"></i> Contact Person <span class="text-danger">*</span>
                        </label>
                        {{ form.contact_person }}
                        <div class="form-text">Primary contact person's full name</div>
                        {% if form.contact_person.errors %}
                        <div class="text-danger mt-1">{{ form.contact_person.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="{{ form.contact_email.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-envelope"></i> Email <span class="text-danger">*</span>
                        </label>
                        {{ form.contact_email }}
                        <div class="form-text">Will be used for login credentials</div>
                        {% if form.contact_email.errors %}
                        <div class="text-danger mt-1">{{ form.contact_email.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.contact_phone.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-phone"></i> Phone <span class="text-danger">*</span>
                        </label>
                        {{ form.contact_phone }}
                        <div class="form-text">Primary contact number</div>
                        {% if form.contact_phone.errors %}
                        <div class="text-danger mt-1">{{ form.contact_phone.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="{{ form.initial_service.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-briefcase"></i> Initial Service
                        </label>
                        {{ form.initial_service }}
                        <div class="form-text">Select the service client is interested in (optional)</div>
                        {% if form.initial_service.errors %}
                        <div class="text-danger mt-1">{{ form.initial_service.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        {% if user.role == 'SALES' or user.role == 'ADMIN' or user.role == 'OWNER' %}
                        <label for="{{ form.assigned_manager.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-person-badge"></i> Assigned Manager
                        </label>
                        {{ form.assigned_manager }}
                        <div class="form-text">{{ form.assigned_manager.help_text }}</div>
                        {% if form.assigned_manager.errors %}
                        <div class="text-danger mt-1">{{ form.assigned_manager.errors }}</div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Revenue Tracking -->
                <div class="card mb-4 border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-currency-rupee"></i> Revenue Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="{{ form.total_pitched_amount.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-cash-stack"></i> Pitched Amount (₹)
                                </label>
                                {{ form.total_pitched_amount }}
                                <div class="form-text">Base amount (excluding GST)</div>
                                {% if form.total_pitched_amount.errors %}
                                <div class="text-danger mt-1">{{ form.total_pitched_amount.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-2">
                                <label for="{{ form.gst_percentage.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-percent"></i> GST %
                                </label>
                                {{ form.gst_percentage }}
                                <div class="form-text">Default 18%</div>
                                {% if form.gst_percentage.errors %}
                                <div class="text-danger mt-1">{{ form.gst_percentage.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3">
                                <label for="{{ form.received_amount.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-check-circle"></i> Received (₹)
                                </label>
                                {{ form.received_amount }}
                                <div class="form-text">Amount received so far</div>
                                {% if form.received_amount.errors %}
                                <div class="text-danger mt-1">{{ form.received_amount.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.pending_amount.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-clock"></i> Pending (₹)
                                </label>
                                {{ form.pending_amount }}
                                <div class="form-text">Auto-calculated: (Pitched + GST) - Received</div>
                                {% if form.pending_amount.errors %}
                                <div class="text-danger mt-1">{{ form.pending_amount.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- GST Breakdown Display -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="alert alert-light border">
                                    <small class="text-muted">GST Amount (18% of Pitched)</small>
                                    <h5 class="mb-0">₹<span id="gst-amount-display">0.00</span></h5>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="alert alert-light border">
                                    <small class="text-muted">Total with GST</small>
                                    <h5 class="mb-0">₹<span id="total-with-gst-display">0.00</span></h5>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-calculator"></i> <strong>Auto-calculation:</strong> GST = Pitched × GST% ÷ 100. Pending = (Pitched + GST) - Received. Updates live as you type!
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-lightbulb"></i> <strong>What happens next?</strong>
                    <ul class="mb-0 mt-2">
                        {% if user.role == 'SALES' %}
                        <li>Client request will be sent to your manager for approval</li>
                        <li>After manager approval, system will auto-generate login credentials</li>
                        <li>Credentials will appear on Owner Dashboard</li>
                        <li>Owner/Admin will share credentials with client</li>
                        <li>Client logs in and completes their profile</li>
                        {% else %}
                        <li>System will auto-generate secure login credentials</li>
                        <li>Credentials will appear on Owner Dashboard</li>
                        <li>Share credentials with client via email/WhatsApp</li>
                        <li>Client logs in and completes their profile</li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Form Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Create Client
                        </button>
                        <a href="{% url 'accounts:dashboard' %}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card mt-3">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-question-circle"></i> Why only 4 fields?</h6>
        </div>
        <div class="card-body">
            <p class="mb-2"><strong>Benefits of Quick Creation:</strong></p>
            <ul class="mb-0">
                <li><strong>Faster onboarding:</strong> Create client in 30 seconds</li>
                <li><strong>Accurate data:</strong> Client provides their own details</li>
                <li><strong>Less errors:</strong> No guessing client information</li>
                <li><strong>Better experience:</strong> Client completes profile at their convenience</li>
            </ul>
        </div>
    </div>
</div>

<script>
// Live GST Calculator
function calculateGST() {
    const pitchedInput = document.querySelector('#id_total_pitched_amount');
    const gstPercentInput = document.querySelector('#id_gst_percentage');
    const receivedInput = document.querySelector('#id_received_amount');
    const pendingInput = document.querySelector('#id_pending_amount');
    
    if (!pitchedInput || !gstPercentInput || !receivedInput || !pendingInput) {
        return; // Fields don't exist yet
    }
    
    const pitched = parseFloat(pitchedInput.value) || 0;
    const gstPercent = parseFloat(gstPercentInput.value) || 18;
    const received = parseFloat(receivedInput.value) || 0;
    
    // Calculate GST amount
    const gstAmount = (pitched * gstPercent) / 100;
    
    // Calculate total with GST
    const totalWithGST = pitched + gstAmount;
    
    // Calculate pending
    const pending = totalWithGST - received;
    
    // Update display fields
    const gstDisplay = document.querySelector('#gst-amount-display');
    const totalDisplay = document.querySelector('#total-with-gst-display');
    
    if (gstDisplay) {
        gstDisplay.textContent = gstAmount.toFixed(2);
    }
    if (totalDisplay) {
        totalDisplay.textContent = totalWithGST.toFixed(2);
    }
    
    // Update hidden pending field (for form submission)
    if (pending >= 0) {
        pendingInput.value = pending.toFixed(2);
    }
}

// Add event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    const pitchedInput = document.querySelector('#id_total_pitched_amount');
    const gstPercentInput = document.querySelector('#id_gst_percentage');
    const receivedInput = document.querySelector('#id_received_amount');
    
    if (pitchedInput) {
        pitchedInput.addEventListener('input', calculateGST);
    }
    if (gstPercentInput) {
        gstPercentInput.addEventListener('input', calculateGST);
    }
    if (receivedInput) {
        receivedInput.addEventListener('input', calculateGST);
    }
    
    // Calculate on page load with existing values
    calculateGST();
});
</script>
{% endblock %}
