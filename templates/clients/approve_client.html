{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block sidebar %}
<nav class="col-md-3 col-lg-2 d-md-block sidebar">
    <div class="position-sticky pt-3">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'accounts:manager_dashboard' %}">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'clients:pending_approval_clients' %}">
                    <i class="bi bi-clock-history"></i> Pending Approvals
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'clients:manager_clients_list' %}">
                    <i class="bi bi-people"></i> Team Clients
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'applications:team_applications_list' %}">
                    <i class="bi bi-file-earmark-text"></i> Applications
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'accounts:team_members_list' %}">
                    <i class="bi bi-people-fill"></i> My Team
                </a>
            </li>
        </ul>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-check-circle"></i> {{ page_title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'clients:pending_approval_clients' %}">Pending Approvals</a></li>
                    <li class="breadcrumb-item active">Review Client</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Client Details Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-building"></i> Client Details</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Client ID:</strong> <code>{{ client.client_id }}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Created By:</strong> {{ client.created_by.get_full_name }} ({{ client.created_by.get_role_display }})
                        </div>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-person-circle"></i> Contact Person</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Name:</strong> {{ client.user.get_full_name }}
                        </div>
                        <div class="col-md-6">
                            <strong>Email:</strong> {{ client.user.email }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Phone:</strong> {{ client.user.phone }}
                        </div>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-building"></i> Company Information</h6>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Company Name:</strong> {{ client.company_name }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Business Type:</strong><br>{{ client.get_business_type_display }}
                        </div>
                        <div class="col-md-4">
                            <strong>Sector:</strong><br>{{ client.get_sector_display }}
                        </div>
                        <div class="col-md-4">
                            <strong>Company Age:</strong><br>{{ client.company_age }} years
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Registration Number:</strong><br>{{ client.registration_number|default:"N/A" }}
                        </div>
                        <div class="col-md-4">
                            <strong>GST Number:</strong><br>{{ client.gst_number|default:"N/A" }}
                        </div>
                        <div class="col-md-4">
                            <strong>PAN Number:</strong><br>{{ client.pan_number|default:"N/A" }}
                        </div>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-geo-alt"></i> Address</h6>
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>Registered Address:</strong><br>
                            {{ client.registered_address }}<br>
                            {{ client.city }}, {{ client.state }} - {{ client.pincode }}
                        </div>
                    </div>
                    {% if client.website %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>Website:</strong> <a href="{{ client.website }}" target="_blank">{{ client.website }}</a>
                        </div>
                    </div>
                    {% endif %}

                    <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-currency-rupee"></i> Financial Information</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Annual Turnover:</strong><br>₹{{ client.annual_turnover|floatformat:2 }} L
                        </div>
                        <div class="col-md-4">
                            <strong>Funding Required:</strong><br>₹{{ client.funding_required|floatformat:2 }} L
                        </div>
                        <div class="col-md-4">
                            <strong>Existing Loans:</strong><br>₹{{ client.existing_loans|floatformat:2 }} L
                        </div>
                    </div>

                    {% if client.business_description %}
                    <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-card-text"></i> Business Description</h6>
                    <p>{{ client.business_description }}</p>
                    {% endif %}

                    {% if client.funding_purpose %}
                    <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-bullseye"></i> Funding Purpose</h6>
                    <p>{{ client.funding_purpose }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Approval Form Card -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> Approval Decision</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label"><strong>Action <span class="text-danger">*</span></strong></label>
                            {% for radio in form.action %}
                            <div class="form-check">
                                {{ radio }}
                            </div>
                            {% endfor %}
                            {% if form.action.errors %}
                            <div class="text-danger">{{ form.action.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3" id="rejection-reason-group">
                            <label for="{{ form.rejection_reason.id_for_label }}" class="form-label">
                                <strong>Rejection Reason</strong>
                            </label>
                            {{ form.rejection_reason }}
                            <div class="form-text">Required if rejecting the client</div>
                            {% if form.rejection_reason.errors %}
                            <div class="text-danger">{{ form.rejection_reason.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Submit Decision
                            </button>
                            <a href="{% url 'clients:pending_approval_clients' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to List
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6><i class="bi bi-info-circle"></i> What happens next?</h6>
                    <ul class="small mb-0">
                        <li><strong>If Approved:</strong> Client will receive login credentials and can access the portal.</li>
                        <li><strong>If Rejected:</strong> Sales person will be notified with the reason.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Show/hide rejection reason based on selection
document.addEventListener('DOMContentLoaded', function() {
    const actionRadios = document.querySelectorAll('input[name="action"]');
    const rejectionGroup = document.getElementById('rejection-reason-group');
    
    function toggleRejectionReason() {
        const selectedAction = document.querySelector('input[name="action"]:checked');
        if (selectedAction && selectedAction.value === 'reject') {
            rejectionGroup.style.display = 'block';
        } else {
            rejectionGroup.style.display = 'none';
        }
    }
    
    actionRadios.forEach(radio => {
        radio.addEventListener('change', toggleRejectionReason);
    });
    
    toggleRejectionReason(); // Initial check
});
</script>
{% endblock %}
