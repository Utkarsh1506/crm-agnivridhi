# PythonAnywhere Deployment - Simplified Client Creation

## Quick Deploy Commands

```bash
# 1. Navigate to project
cd ~/agnivridhi

# 2. Pull latest changes
git pull origin main

# 3. Activate virtual environment
source venv/bin/activate

# 4. Run migrations (IMPORTANT - Makes fields optional)
python manage.py migrate

# 5. Reload web app
# Go to Web tab → Click RELOAD button
```

## What Will Be Applied

### Migration: clients.0005
- Makes 9 fields optional (nullable):
  - business_type, sector, company_age
  - annual_turnover, funding_required
  - address_line1, city, state, pincode

## Test After Deployment

### 1. Test Owner Dashboard Routing
```
Login as: owner / test123
Expected: Should see Owner Dashboard (not Superuser Dashboard)
URL: https://your-app.pythonanywhere.com/dashboard/owner/
```

### 2. Test Quick Client Creation
```
Login as: sales1 / Sales@123
Go to: Create Client
Fill only 4 fields:
  - Company Name: Test Company Quick
  - Contact Person: Test Person
  - Email: testquick@test.com (must be unique)
  - Phone: 9876543210
Submit
Expected: Client created, credentials auto-generated
```

### 3. Test Client Profile Completion
```
Login as: testquick@test.com (username will be 'testquick')
Password: Check Owner Dashboard for auto-generated password
Expected: See "Profile Incomplete" warning
Click: Complete Your Profile
Expected: Beautiful form with progress bar showing low % (like 22%)
Fill: Some fields (not all)
Save
Expected: Percentage increases
Fill: All required fields (business type, sector, age, address, turnover, funding)
Save
Expected: 100% complete, status changes to ACTIVE
```

## Verification Queries

### Check Nullable Fields
```bash
python manage.py dbshell

# For MySQL
DESCRIBE clients_client;

# Look for these fields showing NULL: YES
# - business_type
# - sector  
# - company_age
# - annual_turnover
# - funding_required
# - address_line1
# - city
# - state
# - pincode
```

### Check Existing Clients
```bash
python manage.py shell

from clients.models import Client
clients = Client.objects.all()
for c in clients:
    print(f"{c.company_name}: business_type={c.business_type}, sector={c.sector}")
```

## Create Test Client (Django Shell)

```python
python manage.py shell

from django.contrib.auth import get_user_model
from clients.models import Client
User = get_user_model()

# Create user
user = User.objects.create_user(
    username='testquickprod',
    email='testquickprod@test.com',
    password='Test@123',
    role='CLIENT',
    first_name='Test',
    last_name='Quick'
)

# Create minimal client (only 4 fields)
sales = User.objects.filter(role='SALES').first()
client = Client.objects.create(
    user=user,
    company_name='Test Quick Production',
    contact_person='Test Quick Person',
    contact_email='testquickprod@test.com',
    contact_phone='9876543210',
    created_by=sales,
    status='PENDING_DOCS'
)

print(f"Created: {client.company_name}")
print(f"Client ID: {client.client_id}")
print(f"Status: {client.status}")
print(f"Business Type: {client.business_type}")  # Should be None
print(f"Sector: {client.sector}")  # Should be None

# Check credentials
from clients.models import ClientCredential
cred = ClientCredential.objects.get(client=client)
print(f"\nCredentials:")
print(f"Username: {cred.username}")
print(f"Password: {cred.plain_password}")

exit()
```

## Rollback (If Needed)

```bash
# If something goes wrong
git log --oneline -5
git checkout af8e9e4  # Previous commit
python manage.py migrate clients 0004  # Rollback migration
# Reload web app

# To return to latest
git checkout main
git pull origin main
python manage.py migrate
# Reload web app
```

## URLs to Test

1. **Owner Dashboard**: https://your-app.pythonanywhere.com/dashboard/owner/
2. **Create Client**: https://your-app.pythonanywhere.com/clients/create/
3. **Complete Profile**: https://your-app.pythonanywhere.com/clients/complete-profile/
4. **Client Portal**: https://your-app.pythonanywhere.com/dashboard/client/

## Expected Behavior

### Quick Client Creation Flow:
1. Sales fills 4 fields → Submit
2. Client created with status='PENDING_DOCS'
3. Credentials auto-generated
4. Owner sees credentials on dashboard
5. Owner shares with client
6. Client logs in → Sees "Complete Profile" prompt
7. Client fills details → Status becomes 'ACTIVE'

### Owner Dashboard Flow:
1. Owner logs in
2. Automatically redirected to `/dashboard/owner/`
3. NOT redirected to `/dashboard/superuser/`
4. Sees new client credentials if any
5. Can manually visit superuser dashboard if needed

## Success Indicators

- ✅ Migration applied without errors
- ✅ Owner sees owner dashboard on login
- ✅ Can create client with only 4 fields
- ✅ Client can login and see profile completion page
- ✅ Profile completion percentage shows correctly
- ✅ Status updates to ACTIVE when profile complete
- ✅ Credentials still auto-generated for quick creation

## Troubleshooting

### Issue: "NOT NULL constraint failed"
**Cause**: Migration not applied
**Solution**: 
```bash
python manage.py migrate clients
# Check: python manage.py showmigrations clients
```

### Issue: "Owner still sees superuser dashboard"
**Cause**: Browser cache or session issue
**Solution**:
```bash
# Clear sessions
python manage.py shell
from django.contrib.sessions.models import Session
Session.objects.all().delete()
exit()
# User logs out and logs in again
```

### Issue: "Can't create client with only 4 fields"
**Cause**: Form not using QuickClientCreationForm
**Solution**: Check code was pulled correctly
```bash
grep -n "QuickClientCreationForm" clients/views.py
# Should show usage in create_client view
```

### Issue: "Client can't access complete profile page"
**Cause**: URL not registered or user role wrong
**Solution**:
```bash
python manage.py shell
from django.urls import reverse
print(reverse('clients:complete_profile'))
# Should print: /clients/complete-profile/
```

## Support

Check error logs:
```bash
tail -50 /var/log/your-username.pythonanywhere.com.error.log
```

Check server logs:
```bash
tail -50 /var/log/your-username.pythonanywhere.com.server.log
```

## Summary

**Commit**: 0053024  
**Features**:
1. Owner dashboard routing fixed
2. Quick client creation (4 fields)
3. Client profile completion
4. 9 fields made optional

**Migration**: clients.0005_alter_client_address_line1_and_more  
**Status**: Ready to deploy ✅
